<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <title>Archipeladoku</title>
    <style>body { padding: 0; margin: 0; }</style>
    <script src="app.js"></script>
</head>
<body>
    <div id="ui-container"></div>
    <script type="module">
        import * as Archipelago from "https://unpkg.com/archipelago.js/dist/archipelago.min.js";

        const client = new Archipelago.Client();
        window.client = client; // For debugging purposes
        let uiContainer = document.getElementById('ui-container');

        let ui = Elm.Archipeladoku.UI.init({
            node: uiContainer,
            flags: {}
        });
        let worker = new Worker('worker.js');

        ui.ports.generateBoard && ui.ports.generateBoard.subscribe(data => {
            worker.postMessage({ type: 'generateBoard', data: data });
        });

        ui.ports.checkLocation && ui.ports.checkLocation.subscribe(data => {
            try {
                client.check(data);
            } catch (error) {
                console.error('Check location error:', error);
            }
        });

        client.items.on('itemsReceived', items => {
            console.log('Received items:', items.map(item => item.name));
            ui.ports.receiveItems.send(items.map(item => item.id));
        });

        client.room.on('locationsChecked', locations => {
            console.log('Locations checked:', locations);
            ui.ports.receiveCheckedLocations.send(locations);
        });

        ui.ports.connect && ui.ports.connect.subscribe(data => {
            client.login(data.host, data.player, 'Archipeladoku', { password: data.password })
                .then(slotData => {
                    console.log('Slot Data:', slotData);
                    worker.postMessage({ type: 'generateFromServer', data: slotData });
                })
                .catch(error => {
                    console.error('Connection error:', error);
                });
        })

        worker.onmessage = function(event) {
            console.log(event.data.type, event.data.data);

            switch(event.data.type) {
                case 'sendBoard':
                    ui.ports.receiveBoard.send(event.data.data);

                    break;

                default:
                    console.log('Unknown message type:', event.data.type);
            }
        };

    </script>
</body>
</html>
